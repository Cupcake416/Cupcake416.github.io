{"title":"「UOJ58」[WC2013]糖果公园","date":"2018-03-08T09:12:21.000Z","excerpt":"","slug":"「UOJ58」-WC2013-糖果公园","updated":"2018-07-18T16:01:16.609Z","content":"<h2 id=\"题目大意\"><a href=\"#题目大意\" class=\"headerlink\" title=\"题目大意\"></a>题目大意</h2><p>给定一棵树，每个点有一个颜色$c_i$，每种颜色有一个美味指数$v_i$，$w_i$表示第$i$次遇到某种颜色时的新奇指数，实现下面两种操作：</p>\n<p>1.询问两点间路径上的$\\sum_{}^{} {v_{c_i}*w_j}$，$j$表示第$j$次遇到这种颜色。</p>\n<p>2.修改某个点的颜色</p>\n<h2 id=\"解析\"><a href=\"#解析\" class=\"headerlink\" title=\"解析\"></a>解析</h2><p>树上带修改莫队。</p>\n<p>用欧拉序转化为区间问题，然后就是一个带修改莫队啦。</p>\n<p>注意LCA有特殊情况要处理。</p>\n<p>代码略丑(AC的时候没感觉，第二次看的时候完全忍不了了好吗)，已加入重写计划。</p>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;bits/stdc++.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> ll long long</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> R register</span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> <span class=\"built_in\">std</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">int</span> N=<span class=\"number\">100010</span>,P=<span class=\"number\">20</span>,maxp=<span class=\"number\">17</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"keyword\">int</span> <span class=\"title\">read</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x=<span class=\"number\">0</span>;<span class=\"keyword\">char</span> c=<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(c&lt;<span class=\"string\">'0'</span>||c&gt;<span class=\"string\">'9'</span>) c=getchar();</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(c&gt;=<span class=\"string\">'0'</span>&amp;&amp;c&lt;=<span class=\"string\">'9'</span>)x=(x&lt;&lt;<span class=\"number\">3</span>)+(x&lt;&lt;<span class=\"number\">1</span>)+c-<span class=\"string\">'0'</span>,c=getchar();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">int</span> n,m,q,c[N],temp[N],id[N&lt;&lt;<span class=\"number\">1</span>],totid,siz,bel[N],in[N],out[N],cnt[N];</span><br><span class=\"line\"><span class=\"keyword\">short</span> vis[N];</span><br><span class=\"line\">ll v[N],w[N],ans[N];</span><br><span class=\"line\"><span class=\"built_in\">vector</span>&lt;<span class=\"keyword\">int</span>&gt;g[N];</span><br><span class=\"line\"><span class=\"keyword\">int</span> f[N][P],dep[N];</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">Que</span>&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> l,r,t,id;</span><br><span class=\"line\">    <span class=\"keyword\">bool</span> <span class=\"keyword\">operator</span>&lt;(<span class=\"keyword\">const</span> Que&amp; k)<span class=\"keyword\">const</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(bel[l]==bel[k.l]&amp;&amp;bel[r]==bel[k.r]) <span class=\"keyword\">return</span> t&lt;k.t;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bel[l]==bel[k.l]?r&lt;k.r:l&lt;k.l;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;que[N];</span><br><span class=\"line\"><span class=\"keyword\">int</span> totq,totc,from[N],to[N],pos[N];</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">dfs</span><span class=\"params\">(<span class=\"keyword\">int</span> k,<span class=\"keyword\">int</span> fa,<span class=\"keyword\">int</span> d)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">    f[k][<span class=\"number\">0</span>]=fa,id[++totid]=k,dep[k]=d,in[k]=totid;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;g[k].size();i++)&#123;</span><br><span class=\"line\">        x=g[k][i];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(x==fa) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        dfs(x,k,d+<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    id[++totid]=k,out[k]=totid;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"keyword\">int</span> <span class=\"title\">getlca</span><span class=\"params\">(<span class=\"keyword\">int</span> x,<span class=\"keyword\">int</span> y)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(dep[x]&lt;dep[y]) swap(x,y);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=maxp;i&gt;=<span class=\"number\">0</span>;i--)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(dep[f[x][i]]&gt;=dep[y]) x=f[x][i];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(x==y) <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=maxp;i&gt;=<span class=\"number\">0</span>;i--)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(f[x][i]!=f[y][i]) x=f[x][i],y=f[y][i];</span><br><span class=\"line\">    <span class=\"keyword\">return</span> f[x][<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> opt,t1,t2;</span><br><span class=\"line\">    n=read(),m=read(),q=read(),siz=<span class=\"built_in\">pow</span>(n,<span class=\"number\">2.0</span>/<span class=\"number\">3</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=m;i++) v[i]=read();</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=n;i++) w[i]=read(),bel[i]=i/siz+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;n;i++)&#123;t1=read(),t2=read();g[t1].push_back(t2);g[t2].push_back(t1);&#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=n;i++) c[i]=read(),temp[i]=c[i];</span><br><span class=\"line\">    dfs(<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> j=<span class=\"number\">1</span>;j&lt;=maxp;j++)</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=n;i++) f[i][j]=f[f[i][j<span class=\"number\">-1</span>]][j<span class=\"number\">-1</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=q;i++)&#123;</span><br><span class=\"line\">        opt=read(),t1=read(),t2=read();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!opt) ++totc,from[totc]=temp[t1],to[totc]=t2,pos[totc]=t1,temp[t1]=t2;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(in[t1]&gt;=in[t2]&amp;&amp;out[t1]&lt;=out[t2]||in[t2]&gt;=in[t1]&amp;&amp;out[t2]&lt;=out[t1]) que[++totq]=(Que)&#123;min(in[t1],in[t2]),max(in[t1],in[t2]),totc,totq&#125;;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"built_in\">abs</span>(in[t1]-out[t2])&lt;<span class=\"built_in\">abs</span>(out[t1]-in[t2])) que[++totq]=(Que)&#123;min(in[t1],out[t2]),max(in[t1],out[t2]),totc,totq&#125;;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> que[++totq]=(Que)&#123;min(in[t2],out[t1]),max(in[t2],out[t1]),totc,totq&#125;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    sort(que+<span class=\"number\">1</span>,que+totq+<span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> lca;</span><br><span class=\"line\">    R <span class=\"keyword\">int</span> x,pl=<span class=\"number\">1</span>,pr=<span class=\"number\">0</span>,pt=<span class=\"number\">0</span>;</span><br><span class=\"line\">    R ll res=<span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=totq;i++)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pl&gt;que[i].l)&#123;</span><br><span class=\"line\">            x=id[--pl];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!vis[x]) vis[x]=<span class=\"number\">1</span>,cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],vis[x]=<span class=\"number\">2</span>,cnt[c[x]]--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pr&lt;que[i].r)&#123;</span><br><span class=\"line\">            x=id[++pr];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!vis[x]) vis[x]=<span class=\"number\">1</span>,cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],vis[x]=<span class=\"number\">2</span>,cnt[c[x]]--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pt&lt;que[i].t)&#123;</span><br><span class=\"line\">            pt++;</span><br><span class=\"line\">            x=pos[pt];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],cnt[c[x]]--;</span><br><span class=\"line\">            c[x]=to[pt];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pt&gt;que[i].t)&#123;</span><br><span class=\"line\">            x=pos[pt];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],cnt[c[x]]--;</span><br><span class=\"line\">            c[x]=from[pt];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">            pt--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pl&lt;que[i].l)&#123;</span><br><span class=\"line\">            x=id[pl];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">2</span>) vis[x]=<span class=\"number\">1</span>,cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],vis[x]=<span class=\"number\">0</span>,cnt[c[x]]--;</span><br><span class=\"line\">            pl++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(pr&gt;que[i].r)&#123;</span><br><span class=\"line\">            x=id[pr];</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">2</span>) vis[x]=<span class=\"number\">1</span>,cnt[c[x]]++,res+=v[c[x]]*w[cnt[c[x]]];</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(vis[x]==<span class=\"number\">1</span>) res-=v[c[x]]*w[cnt[c[x]]],vis[x]=<span class=\"number\">0</span>,cnt[c[x]]--;</span><br><span class=\"line\">            pr--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        lca=getlca(id[que[i].l],id[que[i].r]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(lca==id[que[i].l]||lca==id[que[i].r]) ans[que[i].id]=res;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> ans[que[i].id]=res+v[c[lca]]*w[cnt[c[lca]]+<span class=\"number\">1</span>];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(R <span class=\"keyword\">int</span> i=<span class=\"number\">1</span>;i&lt;=totq;i++) <span class=\"built_in\">printf</span>(<span class=\"string\">\"%lld\\n\"</span>,ans[i]);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","prev":{"title":"「luogu2596」[ZJOI2006]书架","slug":"「luogu2596」[ZJOI2006]书架"},"next":{"title":"「BZOJ2120」数颜色","slug":"「BZOJ2120」数颜色"},"link":"/2018/03/08","toc":[{"title":"题目大意","id":"题目大意","index":"1"},{"title":"解析","id":"解析","index":"2"},{"title":"代码","id":"代码","index":"3"}]}